version: 1.0
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing dependencies..."
        - npm install --quiet --global expo-cli
        - npm install
        - echo "Preventing Next.js detection by renaming Next.js files..."
        - |
          if [ -f "next.config.js" ]; then
            mv next.config.js next.config.js.bak
            echo "Renamed next.config.js to next.config.js.bak"
          fi
          if [ -d "pages" ]; then
            mv pages pages.bak
            echo "Renamed pages/ to pages.bak/"
          fi
    build:
      commands:
        - echo "Building Expo web app..."
        - expo build:web || (npx expo export --platform web && mv dist web-build)
        - echo "Build completed"
        - echo "Creating index.html if needed..."
        - |
          if [ -f "web-build/swelly_chat.html" ] && [ ! -f "web-build/index.html" ]; then
            cp web-build/swelly_chat.html web-build/index.html
            echo "Created index.html from swelly_chat.html"
          fi
        - echo "Creating required-server-files.json for Amplify..."
        - echo '{}' > web-build/required-server-files.json
        - echo "Creating server-trace.json for Amplify..."
        - |
          cat > web-build/server-trace.json << 'EOF'
          {"version": 1, "routes": []}
          EOF
        - echo "Verifying build output:"
        - ls -la web-build/ | head -20
        - echo "Checking for required files:"
        - ls -la web-build/*.json || echo "No JSON files found"
        - test -f web-build/index.html && echo "✓ index.html exists" || echo "✗ index.html missing"
        - test -f web-build/required-server-files.json && echo "✓ required-server-files.json exists" || echo "✗ required-server-files.json missing"
        - test -f web-build/server-trace.json && echo "✓ server-trace.json exists" || echo "✗ server-trace.json missing"
        - echo "Final file check - all files in web-build:"
        - find web-build -name "*.json" -type f
        - echo "Build artifacts ready for deployment"
  artifacts:
    baseDirectory: web-build
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - $(npm root --global)/**/*
