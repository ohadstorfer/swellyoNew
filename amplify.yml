version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Preventing Next.js detection..."
        - |
          if [ -f "next.config.js" ]; then
            mv next.config.js next.config.js.bak
            echo "Renamed next.config.js to prevent Next.js detection"
          fi
        - |
          if [ -d "pages" ]; then
            mv pages pages.bak
            echo "Renamed pages directory to prevent Next.js detection"
          fi
        - echo "Installing dependencies..."
        - npm install
    build:
      commands:
        - echo "Building web app with Expo..."
        - npm run build
        - echo "Build completed"
        - echo "Restoring Next.js files..."
        - |
          if [ -f "next.config.js.bak" ]; then
            mv next.config.js.bak next.config.js
          fi
        - |
          if [ -d "pages.bak" ]; then
            mv pages.bak pages
          fi
        - echo "Creating required files for Amplify..."
        - |
          if [ -f "dist/swelly_chat.html" ]; then
            cp dist/swelly_chat.html dist/index.html
            echo "Created index.html from swelly_chat.html"
          fi
        - echo '{}' > dist/required-server-files.json
        - echo "Created required-server-files.json"
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
